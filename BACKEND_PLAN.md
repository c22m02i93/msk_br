# Архитектура и план развёртывания современного API

## Технологии
- **Node.js 20 + TypeScript + Express** — лёгкий стек, подходящий для shared-хостинга с Node или Passenger.
- **MySQL/MariaDB** — совместима со старой БД, поддерживается на обычном хостинге.
- **JWT-аутентификация** — stateless, удобно для фронтенда на React Canvas.
- **Knex** — миграции и слой работы с БД без тяжёлых ORM.
- **Swagger/OpenAPI** — документация для фронтенда и мобильных клиентов.

## Модульная структура
- `src/config` — конфигурация окружения.
- `src/database` — knex-клиент, миграции.
- `src/middleware` — CORS, rate-limit, JWT, валидация.
- `src/modules/auth` — регистрация/логин, выдача JWT.
- `src/modules/content` — CRUD постов/страниц/категорий/тегов.
- `src/modules/media` — загрузка файлов, ресайз превью через `sharp`.
- `src/modules/legacy` — чтение старых таблиц (пример: `news`) без модификации.
- `src/routes` — агрегация маршрутов.

## Главные таблицы (см. `api/src/database/migrations/0001_init.ts`)
- `roles`, `users` — роли и пользователи.
- `categories`, `tags`, `posts`, `pages`, `seo_meta` — базовый контент + SEO.
- `menus`, `menu_items` — навигация.
- `media`, `galleries`, `gallery_items`, `documents` — файлы и альбомы.
- `events`, `schedules`, `contact_messages` — календарь, расписания, формы.

## Параллельная работа со старым сайтом
- Старый PHP остаётся на основном домене.
- Новый фронтенд + API размещаются на поддомене (например, `next.example.com`).
- API имеет `/legacy` маршруты, которые читают таблицы старого движка read-only, чтобы не ломать старый код.

## Миграция данных
1. Разворачиваем новые таблицы миграциями.
2. Создаём роли и админа (SQL/seed).
3. Через `/legacy` получаем данные, преобразуем (slug, SEO), сохраняем через `/content`.
4. Переносим медиа: скачиваем старые файлы, грузим через `/media` для генерации превью.
5. После переноса обновляем меню/ссылки, включая редиректы 301 на новый домен.

## Подключение React Canvas
- Фронтенд обращается к `VITE_API_URL=<api_url>`.
- Авторизация: сохраняем JWT в `localStorage`, отправляем `Authorization: Bearer <token>`.
- Медиа: используем `media.url` и `media.variants.thumbnail` для карточек.

## Развёртывание на shared-хостинге
- Если Node разрешён: ставим зависимости, запускаем `npm run build`, указываем `dist/server.js` как entry (Passenger/pm2). Настраиваем HTTPS и проксирование статики.
- Если Node запрещён: разворачиваем API на отдельном VPS/серверлес, но на том же MySQL. Фронтенд Canvas можно хостить как статику на shared-хостинге.
